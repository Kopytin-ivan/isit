<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <title>КИС производственного холдинга</title>
    <style>
  * { box-sizing: border-box; }

  :root {
    /* Нейтральная тёмная палитра */
    --bg-body: #020617;        /* очень тёмный фон */
    --bg-surface: #0f172a;     /* карточки / панели */
    --bg-surface-soft: #020617;/* сайдбар / подложки */
    --bg-elevated: #111827;    /* хедеры таблиц, топбар */

    --border-subtle: #1f2937;
    --border-strong: #0b1120;

    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --text-soft: #6b7280;

    /* Акценты (взято из Tailwind indigo/green/amber/red) */
    --accent: #6366f1;         /* основной акцент (кнопки, графики) */
    --accent-strong: #4f46e5;  /* hover / активные элементы */
    --accent-soft: rgba(99,102,241,0.16);

    --success: #22c55e;
    --warning: #facc15;
    --danger: #ef4444;

    --pill-bg: rgba(15,23,42,0.9);

    --sidebar-width: 260px;
    --radius-lg: 0.9rem;
    --shadow-soft: 0 18px 45px rgba(15,23,42,0.7);
  }

  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
    color: var(--text-main);
  }

  .app {
    display: flex;
    min-height: 100vh;
    background: radial-gradient(circle at top left, #020617 0, #020617 45%, #020617 100%);
  }

  /* ===== Сайдбар ===== */
  .sidebar {
    width: var(--sidebar-width);
    background:
      radial-gradient(circle at top left, #1e293b 0, #020617 45%, #020617 100%);
    color: #e5e7eb;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-subtle);
  }

  .sidebar-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(15,23,42,0.9);
    background: linear-gradient(135deg, #020617 0, #0f172a 60%, #111827 100%);
  }

  .sidebar-title {
    font-size: 1.05rem;
    font-weight: 600;
    margin: 0 0 0.25rem;
  }

  .sidebar-subtitle {
    font-size: 0.8rem;
    color: var(--text-soft);
    margin: 0;
  }

  .nav {
    list-style: none;
    padding: 0.5rem 0;
    margin: 0;
    flex: 1;
    overflow-y: auto;
  }

  .nav-section-title {
    padding: 0.75rem 1.25rem 0.25rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-soft);
  }

  .nav-item { margin: 0; padding: 0; }

  .nav-button {
    width: 100%;
    border: none;
    outline: none;
    background: transparent;
    color: inherit;
    text-align: left;
    padding: 0.5rem 1.25rem;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 120ms ease, color 120ms ease, transform 80ms ease;
  }

  .nav-button:hover {
    background: rgba(15,23,42,0.9);
  }

  .nav-button.active {
    background: rgba(37,99,235,0.18);
    color: #e5e7eb;
  }

  .nav-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: #4b5563;
  }

  .nav-button.active .nav-dot {
    background: var(--accent);
  }

  .sidebar-footer {
    padding: 0.75rem 1.25rem;
    border-top: 1px solid rgba(15,23,42,0.9);
    font-size: 0.75rem;
    color: var(--text-soft);
    background: radial-gradient(circle at bottom right, #020617 0, #020617 60%, #020617 100%);
  }

  /* ===== Основная часть ===== */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    background: radial-gradient(circle at top left, #020617 0, #020617 45%, #020617 100%);
  }

  .topbar {
    height: 56px;
    background: rgba(15,23,42,0.96);
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.75rem;
    backdrop-filter: blur(12px);
  }

  .topbar-title {
    font-size: 0.9rem;
    color: var(--text-soft);
  }

  .user-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-main);
  }

  .user-circle {
    width: 24px;
    height: 24px;
    border-radius: 999px;
    background: radial-gradient(circle at 30% 30%, #22c55e, #15803d);
  }

  .screen-container {
    flex: 1;
    padding: 1.25rem 1.75rem 1.75rem;
    overflow: auto;
  }

  .screen { display: none; }
  .screen.active { display: block; }

  .page {
    max-width: 1360px;   /* шире, чтобы меньше пустоты по бокам */
    margin: 0 auto;
  }

  .page-header { margin-bottom: 1rem; }

  .page-title {
    margin: 0 0 0.25rem;
    font-size: 1.4rem;
    font-weight: 600;
  }

  .page-subtitle {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-soft);
  }

  /* Карточки */
  .card {
    background: var(--bg-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-subtle);
    padding: 1.1rem 1.25rem;
    box-shadow: var(--shadow-soft);
  }

  .card + .card { margin-top: 0.9rem; }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .card-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
  }

  .muted { color: var(--text-soft); }

  .pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.25);
    padding: 0.15rem 0.6rem;
    font-size: 0.75rem;
    color: var(--text-main);
    background: var(--pill-bg);
  }

  .pill-status-new {
    border-color: rgba(96,165,250,0.4);
    background: linear-gradient(135deg, rgba(37,99,235,0.24), rgba(37,99,235,0.05));
    color: #bfdbfe;
  }

  .pill-status-progress {
    border-color: rgba(250,204,21,0.4);
    background: linear-gradient(135deg, rgba(250,204,21,0.24), rgba(15,23,42,0.5));
    color: #facc15;
  }

  .pill-status-done {
    border-color: rgba(34,197,94,0.4);
    background: linear-gradient(135deg, rgba(22,163,74,0.24), rgba(15,23,42,0.5));
    color: #bbf7d0;
  }

  .pill-role {
    border-color: rgba(45,212,191,0.4);
    background: linear-gradient(135deg, rgba(16,185,129,0.22), rgba(15,23,42,0.5));
    color: #a7f3d0;
  }

  /* Сетки */
  .grid {
    display: grid;
    gap: 1rem;
  }

  .grid-3 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .grid-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  @media (max-width: 1200px) {
    .page { max-width: 100%; }
  }

  @media (max-width: 960px) {
    .app { flex-direction: column; }
    .sidebar {
      width: 100%;
      flex-direction: row;
      overflow-x: auto;
    }
    .sidebar-header, .sidebar-footer { display: none; }
    .nav { display: flex; flex-wrap: nowrap; }
    .nav-button { white-space: nowrap; }
  }

  @media (max-width: 768px) {
    .grid-3, .grid-2 { grid-template-columns: 1fr; }
    .screen-container { padding: 1rem; }
  }

  /* Таблицы */
  .table-wrapper { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  th, td {
    padding: 0.55rem 0.75rem;
    border-bottom: 1px solid #1f2937;
    text-align: left;
    white-space: nowrap;
  }

  th {
    font-weight: 500;
    font-size: 0.8rem;
    color: var(--text-soft);
    background: #020617;
  }

  tr:hover td { background: rgba(15,23,42,0.85); }

  /* Формы */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem 1rem;
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    font-size: 0.85rem;
  }

  .form-field label {
    color: var(--text-muted);
  }

  .form-field input,
  .form-field select,
  .form-field textarea {
    border-radius: 0.6rem;
    border: 1px solid #1f2937;
    padding: 0.45rem 0.6rem;
    background: #020617;
    color: var(--text-main);
  }

  .form-field input:focus,
  .form-field select:focus,
  .form-field textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(99,102,241,0.55);
  }

  .form-actions {
    margin-top: 1rem;
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    align-items: center;
  }

  /* Кнопки */
  .btn {
    border-radius: 999px;
    border: 1px solid transparent;
    padding: 0.45rem 0.95rem;
    font-size: 0.85rem;
    cursor: pointer;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: background 120ms ease, border-color 120ms ease, transform 80ms ease, box-shadow 120ms ease;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent) 0, var(--accent-strong) 100%);
    color: #f9fafb;
    border-color: rgba(129,140,248,0.6);
    box-shadow: 0 10px 25px rgba(37,99,235,0.45);
  }

  .btn-primary:hover {
    transform: translateY(-0.5px);
    box-shadow: 0 14px 30px rgba(37,99,235,0.6);
  }

  .btn-secondary {
    background: rgba(15,23,42,0.9);
    color: var(--text-main);
    border-color: #1f2937;
  }

  .btn-secondary:hover {
    background: #020617;
  }

  .btn-ghost {
    background: transparent;
    color: var(--text-soft);
    border-color: transparent;
  }

  .btn-ghost:hover {
    color: var(--text-main);
    background: rgba(15,23,42,0.6);
  }

  .btn-sm {
    padding: 0.25rem 0.65rem;
    font-size: 0.8rem;
  }

  /* Логин */
  .login-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 56px);
  }

  .login-card { max-width: 420px; width: 100%; }

  .login-title {
    margin: 0 0 0.25rem;
    font-size: 1.4rem;
    font-weight: 600;
  }

  .login-subtitle {
    margin: 0 0 1rem;
    font-size: 0.9rem;
    color: var(--text-soft);
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    border-radius: 999px;
    padding: 0.2rem 0.55rem;
    font-size: 0.75rem;
    background: rgba(37,99,235,0.1);
    color: #c7d2fe;
    border: 1px solid rgba(129,140,248,0.55);
  }

  .badge-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: var(--accent);
  }

  /* Диаграммы */
  .chart-card {
    display: flex;
    flex-direction: column;
  }

  .chart-wrapper {
    position: relative;
    width: 100%;
    height: 260px;
    margin-top: 0.25rem;
  }

  .dashboard-charts {
    margin-top: 1.1rem;
  }
</style>

  <!-- Библиотека для рисования диаграмм -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="app">

  <!-- ===== САЙДБАР ===== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">КИС производственного холдинга</div>
      <p class="sidebar-subtitle">Учебный прототип · макеты экранов</p>
    </div>

    <ul class="nav">
      <!-- Аутентификация -->
      <li class="nav-section-title">Аутентификация</li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-login">
          <span class="nav-dot"></span>
          Вход в систему
        </button>
      </li>

      <!-- Работа пользователя -->
      <li class="nav-section-title">Работа пользователя</li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-dashboard" data-requires-auth="1">
          <span class="nav-dot"></span>Дашборд
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-orders-list" data-requires-auth="1">
          <span class="nav-dot"></span>Заказы (список)
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-order-card" data-requires-auth="1">
          <span class="nav-dot"></span>Заказ (карточка)
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-order-new" data-requires-auth="1">
          <span class="nav-dot"></span>Новый заказ
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-employees-list" data-requires-auth="1">
          <span class="nav-dot"></span>Сотрудники (список)
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-employee-card" data-requires-auth="1">
          <span class="nav-dot"></span>Сотрудник (карточка)
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-reports-list" data-requires-auth="1">
          <span class="nav-dot"></span>Отчёты (список)
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-button" data-screen="screen-report-new" data-requires-auth="1">
          <span class="nav-dot"></span>Создание отчёта
        </button>
      </li>

      <li class="nav-section-title">Администрирование</li>
      <li class="nav-item">
        <button class="nav-button" id="admin-nav-button">
          <span class="nav-dot"></span>
          Администрирование
        </button>
      </li>

    </ul>

    <div class="sidebar-footer">
      Макеты для лабораторной №3 «ИСиТ».
    </div>
  </aside>

  <!-- ===== ОСНОВНАЯ ЧАСТЬ ===== -->
  <main class="main">
    <header class="topbar">
      <div class="topbar-title">Прототип интерфейса · макеты экранов</div>

      <div style="display:flex; align-items:center; gap:0.75rem;">
        <button class="btn btn-ghost btn-sm" id="logout-button" style="display:none;">
          Выйти
        </button>

        <div class="user-badge" id="user-badge">
          <div class="user-circle"></div>
          <div>
            <div id="user-name">Гость</div>
            <div class="muted" id="user-role">не авторизован</div>
          </div>
        </div>
      </div>
    </header>

    <div class="screen-container">
      <div class="page">

        <!-- 1. Авторизация -->
        <section id="screen-login" class="screen">
          <div class="login-wrapper">
            <div class="card login-card">
              <div class="badge">
                <span class="badge-dot"></span>
                Экран 1 · Аутентификация
              </div>

              <h1 class="login-title">Вход в корпоративную систему</h1>
              <p class="login-subtitle">Введите учётные данные.</p>

              <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-field">
                  <label for="login-username">Логин</label>
                  <input id="login-username" type="text" placeholder="user@holding.ru">
                </div>

                <div class="form-field">
                  <label for="login-password">Пароль</label>
                  <input id="login-password" type="password" placeholder="●●●●●●●●">
                </div>
              </div>

              <div class="form-actions" style="justify-content: space-between;">
                <button class="btn btn-primary" id="login-button">Войти</button>
                <button class="btn btn-ghost btn-sm">Забыли пароль?</button>
              </div>
            </div>
          </div>
        </section>

        <!-- 2. Дашборд -->
        <section id="screen-dashboard" class="screen">
          <div class="page-header">
            <h2 class="page-title">Главная панель</h2>
            <p class="page-subtitle">
              Краткий обзор состояния заказов и загрузки сотрудников.
            </p>
          </div>

          <!-- KPI-карточки -->
          <div class="grid grid-3 dashboard-kpis">

            <div class="card">
              <div class="card-header">
                <div>
                  <h3 class="card-title">Активные заказы</h3>
                </div>
                <span class="pill pill-status-progress">+12%</span>
              </div>
              <div id="dashboard-active"
                   style="font-size: 2rem; font-weight: 600;">0</div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <h3 class="card-title">Просроченные</h3>
                </div>
                <span class="pill pill-status-new">Контроль</span>
              </div>
              <div id="dashboard-overdue"
                   style="font-size: 2rem; font-weight: 600; color:#b91c1c;">0</div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <h3 class="card-title">Сотрудники онлайн</h3>
                </div>
                <span class="pill pill-role">Статус: Активен</span>
              </div>
              <div id="dashboard-online"
                   style="font-size: 2rem; font-weight: 600;">0</div>
            </div>
          </div>

          <!-- Диаграммы по заказам -->
          <div class="grid grid-2 dashboard-charts">
            <div class="card chart-card">
              <div class="card-header">
                <h3 class="card-title">Заказы по статусам</h3>
                <span class="muted" style="font-size: 0.8rem;">
                  new / ready / canceled
                </span>
              </div>
              <div class="chart-wrapper">
                <canvas id="orders-status-chart"></canvas>
              </div>
            </div>

            <div class="card chart-card">
              <div class="card-header">
                <h3 class="card-title">Заказы по подразделениям</h3>
                <span class="muted" style="font-size: 0.8rem;">
                  распределение количества заказов
                </span>
              </div>
              <div class="chart-wrapper">
                <canvas id="orders-department-chart"></canvas>
              </div>
            </div>
          </div>
        </section>


                <!-- 3. Список заказов -->
        <section id="screen-orders-list" class="screen">
          <div class="page-header">
            <h2 class="page-title">Заказы — список</h2>
            <p class="page-subtitle">Данные берутся из REST API /api/v1/orders/.</p>
          </div>

          <!-- Фильтры + мини-график -->
          <div class="orders-head-grid">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Фильтры</h3>
                <button class="btn btn-secondary btn-sm" id="orders-reset">Сбросить</button>
              </div>

              <div class="form-grid">
                <div class="form-field">
                  <label>Статус</label>
                  <select id="orders-status-filter">
                    <option value="">Все</option>
                    <option value="new">Новый</option>
                    <option value="ready">Готовый</option>
                    <option value="canceled">Отменён</option>
                  </select>
                </div>

                <div class="form-field">
                  <label>Дата с</label>
                  <input type="date" id="orders-date-from">
                </div>

                <div class="form-field">
                  <label>Дата по</label>
                  <input type="date" id="orders-date-to">
                </div>

                <div class="form-field">
                  <label>Клиент (по идентификатору)</label>
                  <input type="text" id="orders-client-filter"
                         placeholder="Например: 1, 2, ...">
                </div>
              </div>
            </div>

            <div class="card chart-card">
              <div class="card-header">
                <h3 class="card-title">Динамика заказов по датам</h3>
                <span class="muted" style="font-size:0.8rem;">по текущей выборке</span>
              </div>
              <div class="chart-wrapper">
                <canvas id="orders-by-date-chart"></canvas>
              </div>
            </div>
          </div>

          <!-- Таблица заказов на всю ширину -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Результаты</h3>
              <span class="muted" style="font-size:0.8rem;">Клик по строке — открыть карточку заказа</span>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                <tr>
                  <th>№ заказа</th>
                  <th>Клиент (ID)</th>
                  <th>Дата</th>
                  <th>Отдел</th>
                  <th>Менеджер (ID)</th>
                  <th>Статус</th>
                  <th>План. дата</th>
                  <th>Сумма</th>
                </tr>
                </thead>
                <tbody id="orders-tbody">
                <!-- заполняется JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>
        <!-- 4. Карточка заказа -->
        <section id="screen-order-card" class="screen">
          <div class="page-header">
            <h2 class="page-title">Карточка заказа</h2>
            <p class="page-subtitle">Заполняется при выборе строки в списке заказов.</p>
          </div>

          <div class="order-card-grid">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title" id="order-card-title">Заказ не выбран</h3>
              </div>

              <div class="form-grid">
                <div class="form-field">
                  <label>Номер заказа</label>
                  <input id="order-card-number" readonly>
                </div>
                <div class="form-field">
                  <label>Дата создания</label>
                  <input id="order-card-date" readonly>
                </div>
                <div class="form-field">
                  <label>Клиент (ID)</label>
                  <input id="order-card-client" readonly>
                </div>
                <div class="form-field">
                  <label>Ответственный менеджер (ID)</label>
                  <input id="order-card-manager" readonly>
                </div>
                <div class="form-field">
                  <label>Подразделение</label>
                  <input id="order-card-department" readonly>
                </div>
                <div class="form-field">
                  <label>Статус</label>
                  <input id="order-card-status" readonly>
                </div>
                <div class="form-field">
                  <label>Приоритет</label>
                  <input id="order-card-priority" readonly>
                </div>
                <div class="form-field">
                  <label>Плановая дата выполнения</label>
                  <input id="order-card-planned" readonly>
                </div>
                <div class="form-field">
                  <label>Сумма заказа</label>
                  <input id="order-card-amount" readonly>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Состав заказа</h3>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                  <tr>
                    <th>Наименование</th>
                    <th>Кол-во</th>
                    <th>Ед.</th>
                    <th>Цена</th>
                    <th>Сумма</th>
                  </tr>
                  </thead>
                  <tbody id="order-items-tbody">
                  <!-- позиции заказа -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 5. Новый заказ (макет) -->
        <section id="screen-order-new" class="screen">
          <div class="page-header">
            <h2 class="page-title">Новый заказ</h2>
            <p class="page-subtitle">Макет формы создания заказа (в реальной системе запрос пойдёт в API /api/v1/orders/).</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Основные данные заказа</h3>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label>Номер заказа</label>
                <input id="order-new-number" placeholder="ORD-2025-119">
              </div>
              <div class="form-field">
                <label>Клиент</label>
                <select id="order-new-client"></select>
              </div>

              <div class="form-field">
                <label>Подразделение</label>
                <select id="order-new-department"></select>
              </div>

              <div class="form-field">
                <label>Менеджер</label>
                <select id="order-new-manager"></select>
              </div>

              <div class="form-field">
                <label>Статус</label>
                  <select id="order-new-status">
                    <option value="new">Новый</option>
                    <option value="ready">Готов</option>
                    <option value="canceled">Отменён</option>
                  </select>

              </div>
              <div class="form-field">
                <label>Приоритет</label>
                <select id="order-new-priority">
                  <option>Обычный</option>
                  <option>Высокий</option>
                  <option>Низкий</option>
                </select>
              </div>
              <div class="form-field">
                <label>Плановая дата</label>
                <input type="date" id="order-new-planned">
              </div>
              <div class="form-field">
                <label>Сумма (итог)</label>
                <input id="order-new-amount" placeholder="0.00">
              </div>
            </div>

            <div class="form-actions">
              <button class="btn btn-primary btn-sm" id="order-new-save">
                Сохранить
              </button>
              <span class="muted" style="font-size:0.8rem;">
                В данном прототипе данные не записываются в БД, создание заказа демонстрируется в админке.
              </span>
            </div>
          </div>
        </section>

                <!-- 6. Сотрудники — список -->
        <section id="screen-employees-list" class="screen">
          <div class="page-header">
            <h2 class="page-title">Сотрудники — список</h2>
            <p class="page-subtitle">Данные из REST API /api/v1/employees/.</p>
          </div>

          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Все сотрудники</h3>
                <span class="muted" style="font-size:0.8rem;">
                  Клик по строке — открыть карточку сотрудника
                </span>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                  <tr>
                    <th>ФИО</th>
                    <th>Таб. номер</th>
                    <th>Должность</th>
                    <th>Подразделение</th>
                    <th>Телефон</th>
                    <th>Статус</th>
                  </tr>
                  </thead>
                  <tbody id="employees-tbody">
                  <!-- сотрудники -->
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card chart-card">
              <div class="card-header">
                <h3 class="card-title">Сотрудники по подразделениям</h3>
                <span class="muted" style="font-size:0.8rem;">по текущему списку</span>
              </div>
              <div class="chart-wrapper">
                <canvas id="employees-dept-chart"></canvas>
              </div>
            </div>
          </div>
        </section>


        <!-- 7. Карточка сотрудника -->
        <section id="screen-employee-card" class="screen">
          <div class="page-header">
            <h2 class="page-title">Карточка сотрудника</h2>
            <p class="page-subtitle">Заполняется при выборе сотрудника в списке.</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title" id="employee-card-title">Сотрудник не выбран</h3>
            </div>
            <div class="form-grid">
            <div class="form-field">
              <label>ФИО</label>
              <input id="employee-card-fullname">
            </div>
            <div class="form-field">
              <label>Табельный номер</label>
              <input id="employee-card-tab">
            </div>
            <div class="form-field">
              <label>Должность</label>
              <input id="employee-card-position">
            </div>
            <div class="form-field">
              <label>Подразделение</label>
              <input id="employee-card-department">
            </div>
            <div class="form-field">
              <label>Телефон</label>
              <input id="employee-card-phone">
            </div>
            <div class="form-field">
              <label>E-mail</label>
              <input id="employee-card-email">
            </div>
            <div class="form-field">
              <label>Статус</label>
              <input id="employee-card-status">
            </div>
            </div> <!-- конец form-grid -->

            <div class="form-actions">
              <button class="btn btn-primary btn-sm" id="employee-save-button">
                Сохранить изменения
              </button>
              <span class="muted" style="font-size:0.8rem;">
                Сохранение выполняется через REST API /api/v1/employees/&lt;id&gt;/. Нужен вход в /admin/.
              </span>
            </div>

            </div>
          </div>
        </section>

        <!-- 8. Отчёты — список -->
        <section id="screen-reports-list" class="screen">
          <div class="page-header">
            <h2 class="page-title">Отчёты — список</h2>
            <p class="page-subtitle">Данные из REST API /api/v1/reports/.</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Сформированные отчёты</h3>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                <tr>
                  <th>Название</th>
                  <th>Тип</th>
                  <th>Период</th>
                  <th>Формат</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </tr>
                </thead>
                <tbody id="reports-tbody">
                <!-- отчёты -->
                </tbody>
              </table>
            </div>
          </div>
        </section>
        <!-- 8.1 Просмотр отчёта -->
        <section id="screen-report-detail" class="screen">
          <div class="page-header">
            <h2 class="page-title" id="report-detail-title">Отчёт</h2>
            <p class="page-subtitle" id="report-detail-meta">Просмотр данных и скачивание CSV.</p>
          </div>

          <div class="card">
            <div class="card-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
              <h3 class="card-title">Данные отчёта</h3>
              <div style="display:flex; gap:8px;">
                <button class="btn btn-ghost btn-sm" id="report-detail-back">Назад к списку</button>
                <button class="btn btn-primary btn-sm" id="report-detail-download">Скачать CSV</button>
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr id="report-detail-thead"></tr>
                </thead>
                <tbody id="report-detail-tbody"></tbody>
              </table>
            </div>
          </div>
        </section>
        <!-- 9. Создание отчёта -->
        <section id="screen-report-new" class="screen">
          <div class="page-header">
            <h2 class="page-title">Создание отчёта</h2>
            <p class="page-subtitle">POST-запрос в /api/v1/reports/ (нужна авторизация в /admin/).</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Параметры отчёта</h3>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label>Тип отчёта</label>
                <select id="report-type">
                  <option value="orders">По заказам</option>
                  <option value="employees">По сотрудникам</option>
                  <option value="finance">Финансовый</option>
                </select>
              </div>
              <div class="form-field">
                <label>Период с</label>
                <input type="date" id="report-from">
              </div>
              <div class="form-field">
                <label>Период по</label>
                <input type="date" id="report-to">
              </div>
              <div class="form-field">
                <label>Формат</label>
                <select id="report-format">
                  <option value="CSV">CSV</option>
                </select>
              </div>
              <div class="form-field">
                <label>Группировка</label>
                <select id="report-grouping"></select>


              </div>
            </div>

            <div class="form-actions">
              <button class="btn btn-primary btn-sm" id="report-create-button">
                Поставить отчёт в очередь
              </button>
              <span class="muted" style="font-size:0.8rem;">
                Для успешного создания отчёта нужно войти в /admin/ под пользователем с правами администратора.
              </span>
            </div>
          </div>
        </section>

        <!-- 10. Администрирование -->
        <section id="screen-admin" class="screen">
          <div class="page-header">
            <h2 class="page-title">Администрирование</h2>
            <p class="page-subtitle">Список интеграций с внешними системами (API /api/v1/integrations/).</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Интеграции</h3>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                <tr>
                  <th>Название</th>
                  <th>Тип</th>
                  <th>Статус</th>
                  <th>Последний обмен</th>
                </tr>
                </thead>
                <tbody id="integrations-tbody">
                <!-- интеграции -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  // ===== Константы и кеши =====
  const API_BASE = '/api/v1';

  const STATUS_LABELS = {
    new: 'Новый',
    ready: 'Готов',
    canceled: 'Отменён',
  };
const COLORS = {
  primary: '#6366F1',        // основной акцент
  primarySoft: 'rgba(99,102,241,0.2)',
  success: '#22C55E',
  warning: '#FACC15',
  danger: '#EF4444',
  neutral: '#4B5563'
};

  let isAuthenticated = false;
  let cachedOrders = [];
  let cachedEmployees = [];
  let cachedReports = [];
  let cachedClients = [];
  let currentUser = null;

  let selectedOrder = null;
  let selectedEmployee = null;
  let ordersStatusChart = null;
  let ordersDeptChart = null;
  let ordersByDateChart = null;
  let employeesDeptChart = null;
  let selectedReportId = null;

  // ===== Селекторы =====
  const buttons = document.querySelectorAll('.nav-button');
  const screens = document.querySelectorAll('.screen');

  const loginButton = document.getElementById('login-button');
  const logoutButton = document.getElementById('logout-button');
  const userNameEl = document.getElementById('user-name');
  const userRoleEl = document.getElementById('user-role');

  const adminNavButton = document.getElementById('admin-nav-button');

  const ordersStatusFilter = document.getElementById('orders-status-filter');
  const ordersClientFilter = document.getElementById('orders-client-filter');
  const ordersDateFrom = document.getElementById('orders-date-from');
  const ordersDateTo = document.getElementById('orders-date-to');
  const ordersReset = document.getElementById('orders-reset');

  const orderNewSave = document.getElementById('order-new-save');

  const reportCreateButton = document.getElementById('report-create-button');
  const reportTypeSelect = document.getElementById('report-type');
  const reportGroupingSelect = document.getElementById('report-grouping');

  const employeeSaveButton = document.getElementById('employee-save-button'); 
  const reportDetailBack = document.getElementById('report-detail-back');
  const reportDetailDownload = document.getElementById('report-detail-download');

  reportDetailBack?.addEventListener('click', async () => {
    showScreen('screen-reports-list');
    cachedReports = [];
    await loadReports();
  });

  reportDetailDownload?.addEventListener('click', () => {
    if (!selectedReportId) return;
    downloadReportCSV(selectedReportId);
  });

  // ===== Общие утилиты =====
  function showScreen(id) {
    screens.forEach(s => s.classList.toggle('active', s.id === id));
    buttons.forEach(b => b.classList.toggle('active', b.dataset.screen === id));
  }

  function guessRole(username) {
    const u = (username || '').toLowerCase();
    if (u === 'admin') return 'администратор системы';
    if (u.includes('analyst') || u.includes('analitik')) return 'аналитик';
    return 'менеджер по заказам';
  }

  function setAuthState(auth, user = null) {
    isAuthenticated = auth;
    currentUser = user;

    if (auth) {
      userNameEl.textContent = user?.username || 'Пользователь';
      userRoleEl.textContent = 'роль: ' + (user?.role || 'не задана');
      logoutButton.style.display = 'inline-flex';
    } else {
      userNameEl.textContent = 'Гость';
      userRoleEl.textContent = 'не авторизован';
      logoutButton.style.display = 'none';
    }
  }


  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  // ===== Работа с API =====
  async function fetchJSON(url, options = {}) {
    try {
      const resp = await fetch(url, options);

      const ct = (resp.headers.get('content-type') || '').toLowerCase();
      let data = null;

      if (ct.includes('application/json')) {
        data = await resp.json().catch(() => null);
      } else {
        data = await resp.text().catch(() => null);
      }

      if (!resp.ok) {
        console.error('Ошибка запроса', url, resp.status, data);
        return { ok: false, status: resp.status, data };
      }

      return { ok: true, status: resp.status, data };
    } catch (e) {
      console.error('Ошибка сети', url, e);
      return { ok: false, status: 0, data: { detail: 'network error' } };
    }
  }


  async function sessionLogin(username, password) {
    const res = await fetchJSON(`${API_BASE}/auth/session/login/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });
    return res.ok ? res.data : null;
  }

  async function sessionMe() {
    const res = await fetchJSON(`${API_BASE}/auth/session/me/`);
    return res.ok ? res.data : null;
  }

  async function sessionLogout() {
    await fetchJSON(`${API_BASE}/auth/session/logout/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') || '' },
    });
  }


  async function fetchOrders() {
    const res = await fetchJSON(`${API_BASE}/orders/`);
    if (res.ok) cachedOrders = res.data;
    return res.data || [];
  }

  async function fetchEmployees() {
    const res = await fetchJSON(`${API_BASE}/employees/`);
    if (res.ok) cachedEmployees = res.data;
    return res.data || [];
  }

  async function fetchOrderItems(orderId) {
    const res = await fetchJSON(`${API_BASE}/order-items/?order=${orderId}`);
    return res.data || [];
  }

  async function fetchReports() {
    const res = await fetchJSON(`${API_BASE}/reports/`);
    if (res.ok) cachedReports = res.data;
    return res.data || [];
  }

  async function fetchReportPreview(reportId, limit = 200) {
    return await fetchJSON(`${API_BASE}/reports/${reportId}/preview/?limit=${limit}`);
  }

  function downloadReportCSV(reportId) {
    // Браузер скачает файл как attachment
    window.location.href = `${API_BASE}/reports/${reportId}/download/`;
  }


async function fetchClients() {
  const res = await fetchJSON(`${API_BASE}/clients/`);
  if (res.ok) cachedClients = res.data;
  return res.data || [];
}

  function updateReportGroupingOptions() {
    if (!reportTypeSelect || !reportGroupingSelect) return;

    const t = reportTypeSelect.value;

    reportGroupingSelect.innerHTML = '';

    const add = (value, label) => {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label;
      reportGroupingSelect.appendChild(opt);
    };

    add('none', 'Без группировки');

    if (t === 'employees') {
      add('department', 'По подразделениям');
    } else {
      add('client', 'По клиентам');
      add('manager', 'По менеджерам');
    }
  }

function fillSelect(selectEl, options, placeholder = 'Выберите...') {
  if (!selectEl) return;
  selectEl.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = placeholder;
  selectEl.appendChild(opt0);

  options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = String(o.value);
    opt.textContent = o.label;
    selectEl.appendChild(opt);
  });
}

async function loadOrderNewLookups() {
  const [clients, employees] = await Promise.all([
    cachedClients?.length ? cachedClients : fetchClients(),
    cachedEmployees.length ? cachedEmployees : fetchEmployees(),
  ]);

  // Клиенты
  const clientSelect = document.getElementById('order-new-client');
  fillSelect(
    clientSelect,
    clients.map(c => ({ value: c.id, label: c.name })),
    'Выберите клиента'
  );

  // Менеджеры (по факту — сотрудники; позже можно фильтровать по должности/роли)
  const managerSelect = document.getElementById('order-new-manager');
  fillSelect(
    managerSelect,
    employees.map(e => ({ value: e.id, label: `${e.full_name} (ID: ${e.id})` })),
    'Выберите менеджера'
  );

  // Подразделения из сотрудников
  const departments = Array.from(new Set(
    employees.map(e => (e.department || '').trim()).filter(Boolean)
  )).sort((a,b) => a.localeCompare(b));

  const depSelect = document.getElementById('order-new-department');
  fillSelect(
    depSelect,
    departments.map(d => ({ value: d, label: d })),
    'Выберите подразделение'
  );

  // Удобство: при выборе менеджера — автоподстановка подразделения
  managerSelect?.addEventListener('change', () => {
    const emp = employees.find(e => String(e.id) === managerSelect.value);
    if (emp && emp.department) depSelect.value = emp.department;
  });
}


  // ===== Дашборд =====
  async function loadDashboard() {
    const [orders, employees] = await Promise.all([
      cachedOrders.length ? cachedOrders : fetchOrders(),
      cachedEmployees.length ? cachedEmployees : fetchEmployees(),
    ]);

    const today = new Date();

    let active = 0;
    let overdue = 0;

    // агрегаты для диаграмм
    const statusCounts = { new: 0, ready: 0, canceled: 0 };
    const departmentCounts = {};

    orders.forEach(o => {
      const status = o.status || 'new';

      // активные = все кроме отменённых
      if (status !== 'canceled') active++;

      // просроченные = есть плановая дата в прошлом и статус "new"
      if (o.planned_date && status === 'new') {
        const planned = new Date(o.planned_date);
        if (planned < today) overdue++;
      }

      // считаем по статусам
      if (statusCounts[status] !== undefined) {
        statusCounts[status] += 1;
      }

      // считаем по подразделениям
      const dep = o.department || 'Не указано';
      if (!departmentCounts[dep]) {
        departmentCounts[dep] = 0;
      }
      departmentCounts[dep] += 1;
    });

    const online = employees.filter(e => e.status === 'Активен').length;

    const activeEl = document.getElementById('dashboard-active');
    const overdueEl = document.getElementById('dashboard-overdue');
    const onlineEl = document.getElementById('dashboard-online');

    if (activeEl) activeEl.textContent = active;
    if (overdueEl) overdueEl.textContent = overdue;
    if (onlineEl) onlineEl.textContent = online;

    // рисуем/обновляем диаграммы
    renderDashboardCharts(statusCounts, departmentCounts);
  }

  function renderDashboardCharts(statusCounts, departmentCounts) {
    const statusCanvas = document.getElementById('orders-status-chart');
    const deptCanvas = document.getElementById('orders-department-chart');

    if (!statusCanvas || !deptCanvas) {
      return;
    }

    // --- Диаграмма по статусам ---
    const statusKeys = ['new', 'ready', 'canceled'];
    const statusLabels = statusKeys.map(k => STATUS_LABELS[k] || k);
    const statusData = statusKeys.map(k => statusCounts[k] || 0);

    if (ordersStatusChart) {
      // обновляем данные
      ordersStatusChart.data.labels = statusLabels;
      ordersStatusChart.data.datasets[0].data = statusData;
      ordersStatusChart.update();
    } else {
      ordersStatusChart = new Chart(statusCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: statusLabels,
          datasets: [
            {
              label: 'Количество заказов',
              data: statusData,
              backgroundColor: [COLORS.primary, COLORS.success, COLORS.danger]
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              callbacks: {
                label: ctx => `Заказов: ${ctx.parsed.y}`,
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
              },
            },
          },
        },
      });
    }

    // --- Диаграмма по подразделениям ---
    const deptLabels = Object.keys(departmentCounts);
    const deptData = deptLabels.map(d => departmentCounts[d]);

    if (ordersDeptChart) {
      ordersDeptChart.data.labels = deptLabels;
      ordersDeptChart.data.datasets[0].data = deptData;
      ordersDeptChart.update();
    } else {
      ordersDeptChart = new Chart(deptCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: deptLabels,
          datasets: [
            {
              label: 'Количество заказов',
              data: deptData,
              backgroundColor: COLORS.primary
            },
          ],
        },
        options: {
          indexAxis: 'y', // горизонтальные столбики
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              callbacks: {
                label: ctx => `Заказов: ${ctx.parsed.x}`,
              },
            },
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                precision: 0,
              },
            },
          },
        },
      });
    }
  }
  function renderOrdersCharts(orders) {
    const canvas = document.getElementById('orders-by-date-chart');
    if (!canvas) return;

    const counts = {};
    orders.forEach(o => {
      if (!o.date) return;
      counts[o.date] = (counts[o.date] || 0) + 1;
    });

    const labels = Object.keys(counts).sort();
    const data = labels.map(d => counts[d]);

    // если данных нет — удаляем график
    if (!labels.length) {
      if (ordersByDateChart) {
        ordersByDateChart.destroy();
        ordersByDateChart = null;
      }
      return;
    }

    if (ordersByDateChart) {
      ordersByDateChart.data.labels = labels;
      ordersByDateChart.data.datasets[0].data = data;
      ordersByDateChart.update();
    } else {
      ordersByDateChart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Количество заказов',
            data,
            tension: 0.3,
            fill: true,
            backgroundColor: COLORS.primarySoft,
            borderColor: COLORS.primary,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `Заказов: ${ctx.parsed.y}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });
    }
  }

  // ===== Заказы — список =====
  function applyOrderFilters(orders) {
    const statusFilter = ordersStatusFilter ? ordersStatusFilter.value : '';
    const clientFilter = ordersClientFilter ? ordersClientFilter.value.trim() : '';
    const from = ordersDateFrom ? ordersDateFrom.value : '';
    const to = ordersDateTo ? ordersDateTo.value : '';

    return orders.filter(o => {
      if (statusFilter && o.status !== statusFilter) return false;
      if (clientFilter && String(o.client) !== clientFilter) return false;
      if (from && o.date && o.date < from) return false;
      if (to && o.date && o.date > to) return false;
      return true;
    });
  }

    function renderOrdersTable(orders) {
    const tbody = document.getElementById('orders-tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!orders.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="8" style="color:#9ca3af;">Нет данных для отображения</td>';
      tbody.appendChild(tr);
      // обновим график пустыми данными
      renderOrdersCharts([]);
      return;
    }

    orders.forEach(order => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';

      const statusLabel = STATUS_LABELS[order.status] || order.status || '';

      tr.innerHTML = `
        <td>${order.number}</td>
        <td>${order.client}</td>
        <td>${order.date || ''}</td>
        <td>${order.department || ''}</td>
        <td>${order.manager || ''}</td>
        <td>${statusLabel}</td>
        <td>${order.planned_date || ''}</td>
        <td>${order.amount_total || ''}</td>
      `;

      tr.addEventListener('click', () => {
        selectedOrder = order;
        renderOrderCard();
        showScreen('screen-order-card');
      });

      tbody.appendChild(tr);
    });

    // один раз после заполнения таблицы
    renderOrdersCharts(orders);
  }

  async function loadOrders() {
    const data = cachedOrders.length ? cachedOrders : await fetchOrders();
    const filtered = applyOrderFilters(data);
    renderOrdersTable(filtered);
  }

  // ===== Карточка заказа =====
  async function renderOrderCard() {
    const titleEl = document.getElementById('order-card-title');
    if (!selectedOrder) {
      if (titleEl) titleEl.textContent = 'Заказ не выбран';
      return;
    }

    const byId = id => document.getElementById(id);
    if (titleEl) titleEl.textContent = `Заказ ${selectedOrder.number}`;

    byId('order-card-number').value = selectedOrder.number || '';
    byId('order-card-date').value = selectedOrder.date || '';
    byId('order-card-client').value = selectedOrder.client || '';
    byId('order-card-manager').value = selectedOrder.manager || '';
    byId('order-card-department').value = selectedOrder.department || '';
    byId('order-card-status').value =
      STATUS_LABELS[selectedOrder.status] || selectedOrder.status || '';
    byId('order-card-priority').value = selectedOrder.priority || '';
    byId('order-card-planned').value = selectedOrder.planned_date || '';
    byId('order-card-amount').value = selectedOrder.amount_total || '';

    const items = await fetchOrderItems(selectedOrder.id);
    const tbody = document.getElementById('order-items-tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!items.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="5" style="color:#9ca3af;">Позиции заказа отсутствуют</td>';
      tbody.appendChild(tr);
      return;
    }

    items.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>${item.unit}</td>
        <td>${item.price}</td>
        <td>${item.amount}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===== Сотрудники =====
  function renderEmployeesTable(employees) {
    const tbody = document.getElementById('employees-tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!employees.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="6" style="color:#9ca3af;">Нет данных для отображения</td>';
      tbody.appendChild(tr);
      return;
    }

    employees.forEach(emp => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.innerHTML = `
        <td>${emp.full_name}</td>
        <td>${emp.tab_number}</td>
        <td>${emp.position}</td>
        <td>${emp.department}</td>
        <td>${emp.phone}</td>
        <td>${emp.status}</td>
      `;
      tr.addEventListener('click', () => {
        selectedEmployee = emp;
        renderEmployeeCard();
        showScreen('screen-employee-card');
      });
      tbody.appendChild(tr);
    });
        renderEmployeesCharts(employees);

  }

  async function loadEmployees() {
    const employees = cachedEmployees.length ? cachedEmployees : await fetchEmployees();
    renderEmployeesTable(employees);
  }

  function renderEmployeeCard() {
    const titleEl = document.getElementById('employee-card-title');
    if (!selectedEmployee) {
      if (titleEl) titleEl.textContent = 'Сотрудник не выбран';
      return;
    }

    const byId = id => document.getElementById(id);

    if (titleEl) titleEl.textContent = selectedEmployee.full_name || 'Сотрудник';
    byId('employee-card-fullname').value = selectedEmployee.full_name || '';
    byId('employee-card-tab').value = selectedEmployee.tab_number || '';
    byId('employee-card-position').value = selectedEmployee.position || '';
    byId('employee-card-department').value = selectedEmployee.department || '';
    byId('employee-card-phone').value = selectedEmployee.phone || '';
    byId('employee-card-email').value = selectedEmployee.email || '';
    byId('employee-card-status').value = selectedEmployee.status || '';
  }
  function renderEmployeesCharts(employees) {
    const canvas = document.getElementById('employees-dept-chart');
    if (!canvas) return;

    const counts = {};
    employees.forEach(e => {
      const dep = e.department || 'Без подразделения';
      counts[dep] = (counts[dep] || 0) + 1;
    });

    const labels = Object.keys(counts);
    const data = labels.map(l => counts[l]);

    if (!labels.length) {
      if (employeesDeptChart) {
        employeesDeptChart.destroy();
        employeesDeptChart = null;
      }
      return;
    }

    const palette = [COLORS.primary, COLORS.success, COLORS.warning, COLORS.danger];
    const colors = labels.map((_, i) => palette[i % palette.length]);

    if (employeesDeptChart) {
      employeesDeptChart.data.labels = labels;
      employeesDeptChart.data.datasets[0].data = data;
      employeesDeptChart.data.datasets[0].backgroundColor = colors;
      employeesDeptChart.update();
    } else {
      employeesDeptChart = new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12 }
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.parsed} сотрудн.`
              }
            }
          }
        }
      });
    }
  }

  // ===== Отчёты =====
  function renderReportsTable(reports) {
    const tbody = document.getElementById('reports-tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!reports.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="6" style="color:#9ca3af;">Отчёты отсутствуют</td>';
      tbody.appendChild(tr);
      return;
    }

    const typeMap = {
      orders: 'По заказам',
      employees: 'По сотрудникам',
      finance: 'Финансовый',
    };

    const statusMap = {
      ready: 'Готов',
      processing: 'В процессе',
      error: 'Ошибка',
    };

    reports.forEach(r => {
      const tr = document.createElement('tr');
      const period =
        (r.period_from || '') + (r.period_to ? ' — ' + r.period_to : '');
        tr.innerHTML = `
          <td>${r.title}</td>
          <td>${typeMap[r.report_type] || r.report_type}</td>
          <td>${period}</td>
          <td>${r.format}</td>
          <td>${statusMap[r.status] || r.status}</td>
          <td style="white-space:nowrap;">
            <button class="btn btn-ghost btn-sm" data-action="open">Открыть</button>
            <button class="btn btn-ghost btn-sm" data-action="download">CSV</button>
          </td>
        `;
        tr.querySelector('[data-action="open"]').addEventListener('click', async (e) => {
        e.stopPropagation();
        await openReportDetail(r.id);
        });

        tr.querySelector('[data-action="download"]').addEventListener('click', (e) => {
          e.stopPropagation();
          downloadReportCSV(r.id);
        });

      tbody.appendChild(tr);
    });
  }

  async function loadReports() {
    const reports = cachedReports.length ? cachedReports : await fetchReports();
    renderReportsTable(reports);
  }
  function renderReportDetailTable(columns, rows) {
  const thead = document.getElementById('report-detail-thead');
  const tbody = document.getElementById('report-detail-tbody');
  if (!thead || !tbody) return;

  thead.innerHTML = '';
  tbody.innerHTML = '';

  // Заголовки
  columns.forEach(c => {
    const th = document.createElement('th');
    th.textContent = c;
    thead.appendChild(th);
  });

  // Строки
  if (!rows || !rows.length) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="${columns.length || 1}" style="color:#9ca3af;">Нет данных</td>`;
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = columns.map(c => `<td>${r[c] ?? ''}</td>`).join('');
    tbody.appendChild(tr);
  });
  }

  async function openReportDetail(reportId) {
    selectedReportId = reportId;

    const res = await fetchReportPreview(reportId, 200);
    if (!res.ok) {
      alert('Не удалось открыть отчёт: ' + (res.data?.detail || 'ошибка'));
      return;
    }

    const titleEl = document.getElementById('report-detail-title');
    const metaEl = document.getElementById('report-detail-meta');

    titleEl.textContent = res.data.title || 'Отчёт';
    metaEl.textContent = `Тип: ${res.data.report_type}, группировка: ${res.data.grouping || 'none'}, формат: ${res.data.format}, строк: ${res.data.rows_count ?? res.data.rows?.length ?? 0}`;

    renderReportDetailTable(res.data.columns || [], res.data.rows || []);
    showScreen('screen-report-detail');
  }

// ===== Сохранение сотрудника =====
async function saveEmployee() {
  if (!selectedEmployee) {
    alert('Сотрудник не выбран');
    return;
  }

  const payload = {
    full_name: document.getElementById('employee-card-fullname').value.trim(),
    tab_number: document.getElementById('employee-card-tab').value.trim(),
    position: document.getElementById('employee-card-position').value.trim(),
    department: document.getElementById('employee-card-department').value.trim(),
    phone: document.getElementById('employee-card-phone').value.trim(),
    email: document.getElementById('employee-card-email').value.trim(),
    status: document.getElementById('employee-card-status').value.trim(),
  };

  const res = await fetchJSON(`${API_BASE}/employees/${selectedEmployee.id}/`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken') || '',
    },
    body: JSON.stringify(payload),
  });

  if (res.ok) {
    alert('Изменения сохранены.');
    cachedEmployees = [];          // сбросим кеш
    await loadEmployees();         // перечитаем список
  } else if (res.status === 403) {
    alert('Нет прав на изменение. Нужно войти в /admin/ под пользователем с правами.');
  } else {
    alert('Ошибка при сохранении сотрудника. Подробности — в консоли браузера.');
  }
}

  // ===== Создание отчёта =====
  async function createReport() {
    const type = document.getElementById('report-type').value;
    const from = document.getElementById('report-from').value || null;
    const to = document.getElementById('report-to').value || null;
    const format = document.getElementById('report-format').value;
    const grouping = document.getElementById('report-grouping').value || '';

    const title = `Отчёт (${type}) ${from || ''} ${to || ''}`;

    const payload = {
      title,
      report_type: type,
      period_from: from,
      period_to: to,
      format,
      grouping,
    };

    const res = await fetchJSON(`${API_BASE}/reports/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken') || '',
      },
      body: JSON.stringify(payload),
    });

    if (res.ok) {
      alert('Отчёт успешно создан.');
      cachedReports = [];
      await loadReports();
      showScreen('screen-reports-list');
    } else {
      alert('Не удалось создать отчёт. Скорее всего, нет прав (нужно войти в /admin/).');
    }
  }

  // ===== Создание заказа =====
  async function createOrder() {
    const number = document.getElementById('order-new-number').value.trim();
    const client = document.getElementById('order-new-client').value.trim();
    const department = document.getElementById('order-new-department').value.trim();
    const manager = document.getElementById('order-new-manager').value.trim();
    const status = document.getElementById('order-new-status').value;
    const priority = document.getElementById('order-new-priority').value;
    const planned = document.getElementById('order-new-planned').value || null;
    const amountRaw = document.getElementById('order-new-amount').value.trim();
    const amount = amountRaw ? parseFloat(amountRaw.replace(',', '.')) : 0;

    if (!number || !client || !department || !manager) {
      alert('Заполните номер, клиента, подразделение и менеджера.');
      return;
    }

    const payload = {
      number,
      client: Number(client),
      department,
      manager: Number(manager),
      status,
      priority,
      planned_date: planned,
      amount_total: amount,
    };

    const res = await fetchJSON(`${API_BASE}/orders/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken') || '',
      },
      body: JSON.stringify(payload),
    });

    if (res.ok) {
      alert('Заказ успешно создан.');
      cachedOrders = [];
      await loadOrders();
      await loadDashboard();
    } else if (res.status === 400) {
      alert('Сервер вернул ошибку валидации (400). Проверьте, что client и manager — существующие ID.');
    } else if (res.status === 403) {
      alert('Нет прав на создание заказа. Нужно войти в /admin/ под пользователем с правами.');
    } else {
      alert('Ошибка при создании заказа. Подробности в консоли браузера.');
    }
  }

  // ===== Обработчики UI =====

  // стартовое состояние
  const me = await sessionMe();
  if (me) {
    setAuthState(true, me);
    showScreen('screen-dashboard');
    await loadDashboard();
  } else {
    setAuthState(false);
    showScreen('screen-login');
  }
  reportTypeSelect?.addEventListener('change', () => {
    updateReportGroupingOptions();
  });


  // навигация по вкладкам
  buttons.forEach(btn => {
    // Администрирование обрабатываем отдельно
    if (btn.id === 'admin-nav-button') return;

    btn.addEventListener('click', async () => {
      const target = btn.dataset.screen;
      const requiresAuth =
        btn.dataset.requires_auth === '1' || btn.dataset.requiresAuth === '1';

      if (requiresAuth && !isAuthenticated) {
        alert('Сначала войдите в систему.');
        showScreen('screen-login');
        return;
      }

      showScreen(target);

      if (target === 'screen-dashboard') {
        loadDashboard();
      } else if (target === 'screen-orders-list') {
        loadOrders();
      } else if (target === 'screen-employees-list') {
        loadEmployees();
      } else if (target === 'screen-reports-list') {
        loadReports();
      } else if (target === 'screen-order-new') {
        await loadOrderNewLookups();
      } else if (target === 'screen-report-new') {
        updateReportGroupingOptions();
      }

    });
  });

  // кнопка "Администрирование" -> переход в /admin/
  if (adminNavButton) {
    adminNavButton.addEventListener('click', () => {
      window.location.href = 'http://127.0.0.1:8000/admin/login/?next=/admin/';
    });
  }

  // фильтры заказов
  [ordersStatusFilter, ordersClientFilter, ordersDateFrom, ordersDateTo]
    .forEach(el => {
      if (el) el.addEventListener('input', () => {
        if (isAuthenticated) loadOrders();
      });
    });

  if (ordersReset) {
    ordersReset.addEventListener('click', () => {
      if (ordersStatusFilter) ordersStatusFilter.value = '';
      if (ordersClientFilter) ordersClientFilter.value = '';
      if (ordersDateFrom) ordersDateFrom.value = '';
      if (ordersDateTo) ordersDateTo.value = '';
      if (isAuthenticated) loadOrders();
    });
  }

  // "Войти" — псевдо-логин (настоящая авторизация через /admin/)
  if (loginButton) {
    loginButton.addEventListener('click', async () => {
      const username = (document.getElementById('login-username')?.value || '').trim();
      const password = (document.getElementById('login-password')?.value || '');

      if (!username || !password) {
        alert('Введите логин и пароль.');
        return;
      }

      const user = await sessionLogin(username, password);
      if (!user) {
        alert('Не удалось войти. Проверьте логин/пароль.');
        return;
      }

      setAuthState(true, user);
      showScreen('screen-dashboard');
      await loadDashboard();
    });

  }

  // "Выйти"
  if (logoutButton) {
    logoutButton.addEventListener('click', async () => {
      await sessionLogout();
      setAuthState(false);
      showScreen('screen-login');
    });
  }

  // Сохранение нового заказа
  if (orderNewSave) {
    orderNewSave.addEventListener('click', async () => {
      if (!isAuthenticated) {
        alert('Сначала войдите в систему.');
        return;
      }

      const canEdit = !!currentUser?.permissions?.can_edit_orders || !!currentUser?.permissions?.is_admin;
      if (!canEdit) {
        alert('У вашей роли нет прав на создание заказов.');
        return;
      }

      await createOrder();
    });
  }

  // Создание отчёта
  if (reportCreateButton) {
    reportCreateButton.addEventListener('click', () => {
      if (!isAuthenticated) {
        alert('Для создания отчёта войдите в систему и в /admin/.');
        return;
      }
      createReport();
    });
  }
  // Сохранение сотрудника
  if (employeeSaveButton) {
    employeeSaveButton.addEventListener('click', () => {
      if (!isAuthenticated) {
        alert('Для сохранения данных войдите в систему и в /admin/.');
        return;
      }
      saveEmployee();
    });
  }

});
</script>


</body>
</html>
